var Space={SHIP_SPEED:3,BASE_ASTEROID_DELAY:500,BASE_ASTEROID_SPEED:1500,FTB_SPEED:6e4,STAR_WIDTH:3e3,STAR_HEIGHT:3e3,NUM_STARS:200,STAR_SPEED:6e4,FRAME_DELAY:100,stars:null,backStars:null,ship:null,lastMove:null,done:!1,shipX:null,shipY:null,hull:0,name:"Space",init:function(e){this.options=$.extend(this.options,e),this.panel=$("<div>").attr("id","spacePanel").addClass("location").appendTo("#outerSlider"),Space.ship=$("<div>").text("@").attr("id","ship").appendTo(this.panel);var a=$("<div>").attr("id","hullRemaining").appendTo(this.panel);$("<div>").addClass("row_key").text(_("hull: ")).appendTo(a),$("<div>").addClass("row_val").appendTo(a),$.Dispatch("stateUpdate").subscribe(Space.handleStateUpdates)},options:{},onArrival:function(){Space.done=!1,Engine.keyLock=!1,Space.hull=Ship.getMaxHull(),Space.altitude=0,Space.setTitle(),AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_SPACE),Space.updateHull(),Space.up=Space.down=Space.left=Space.right=!1,Space.ship.css({top:"350px",left:"350px"}),Space.startAscent(),Space._shipTimer=setInterval(Space.moveShip,33),Space._volumeTimer=setInterval(Space.lowerVolume,1e3),AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_SPACE)},setTitle:function(){var e;Engine.activeModule==this&&(e=Space.altitude<10?_("Troposphere"):Space.altitude<20?_("Stratosphere"):Space.altitude<30?_("Mesosphere"):Space.altitude<45?_("Thermosphere"):Space.altitude<60?_("Exosphere"):_("Space"),document.title=e)},getSpeed:function(){return Space.SHIP_SPEED+$SM.get("game.spaceShip.thrusters")},updateHull:function(){$("div#hullRemaining div.row_val",Space.panel).text(Space.hull+"/"+Ship.getMaxHull())},createAsteroid:function(e){var a,t=Math.random();a=t<.2?"#":t<.4?"$":t<.6?"%":t<.8?"&":"H";var n=Math.floor(700*Math.random()),o=$("<div>").addClass("asteroid").text(a).appendTo("#spacePanel").css("left",n+"px");o.data({xMin:n,xMax:n+o.width(),height:o.height()}),o.animate({top:"740px"},{duration:Space.BASE_ASTEROID_SPEED-Math.floor(Math.random()*(.65*Space.BASE_ASTEROID_SPEED)),easing:"linear",progress:function(){var e=$(this);if(e.data("xMin")<=Space.shipX&&e.data("xMax")>=Space.shipX){var a=e.css("top");if((a=parseFloat(a.substring(0,a.length-2)))<=Space.shipY&&a+e.data("height")>=Space.shipY){Engine.log("collision"),e.remove(),Space.hull--,Space.updateHull();var t=Math.floor(2*Math.random());Space.altitude>40?(t+=6,AudioEngine.playSound(AudioLibrary["ASTEROID_HIT_"+t])):Space.altitude>20?(t+=4,AudioEngine.playSound(AudioLibrary["ASTEROID_HIT_"+t])):(t+=1,AudioEngine.playSound(AudioLibrary["ASTEROID_HIT_"+t])),0===Space.hull&&Space.crash()}}},complete:function(){$(this).remove()}}),e||(Space.altitude>10&&Space.createAsteroid(!0),Space.altitude>20&&(Space.createAsteroid(!0),Space.createAsteroid(!0)),Space.altitude>40&&(Space.createAsteroid(!0),Space.createAsteroid(!0)),Space.done||Engine.setTimeout(Space.createAsteroid,1e3-10*Space.altitude,!0))},moveShip:function(){var e=Space.ship.css("left");e=parseFloat(e.substring(0,e.length-2));var a=Space.ship.css("top");a=parseFloat(a.substring(0,a.length-2));var t=0,n=0;if(Space.up?n-=Space.getSpeed():Space.down&&(n+=Space.getSpeed()),Space.left?t-=Space.getSpeed():Space.right&&(t+=Space.getSpeed()),0!==t&&0!==n&&(t/=Math.sqrt(2),n/=Math.sqrt(2)),null!=Space.lastMove){var o=Date.now()-Space.lastMove;t*=o/33,n*=o/33}(e+=t)<10?e=10:e>690&&(e=690),(a+=n)<10?a=10:a>690&&(a=690),Space.shipX=e,Space.shipY=a,Space.ship.css({left:e+"px",top:a+"px"}),Space.lastMove=Date.now()},startAscent:function(){var e,a;Engine.isLightsOff()?(e="#272823",a="#EEEEEE"):(e="#FFFFFF",a="#000000"),$("body").addClass("noMask").css({backgroundColor:e}).animate({backgroundColor:a},{duration:Space.FTB_SPEED,easing:"linear",progress:function(){var e=$("body").css("background-color"),a="linear-gradient(rgba"+e.substring(3,e.length-1)+", 0) 0%, rgba"+e.substring(3,e.length-1)+", 1) 100%)";$("#notifyGradient").attr("style","background-color:"+e+";background:-webkit-"+a+";background:"+a)},complete:Space.endGame}),Space.drawStars(),Space._timer=setInterval((function(){Space.altitude+=1,Space.altitude%10==0&&Space.setTitle(),Space.altitude>60&&clearInterval(Space._timer)}),1e3),Space._panelTimeout=Engine.setTimeout((function(){Engine.isLightsOff()?$("#spacePanel, .menu, select.menuBtn").animate({color:"#272823"},500,"linear"):$("#spacePanel, .menu, select.menuBtn").animate({color:"white"},500,"linear")}),Space.FTB_SPEED/2,!0),Space.createAsteroid()},drawStars:function(e){var a=$("<div>").attr("id","starsContainer").appendTo("body");Space.stars=$("<div>").css("bottom","0px").attr("id","stars").appendTo(a);var t=$("<div>").css({width:Space.STAR_WIDTH+"px",height:Space.STAR_HEIGHT+"px"}),n=t.clone();Space.stars.append(t).append(n),Space.drawStarAsync(t,n,0),Space.stars.data("speed",Space.STAR_SPEED),Space.startAnimation(Space.stars),Space.starsBack=$("<div>").css("bottom","0px").attr("id","starsBack").appendTo(a),n=(t=$("<div>").css({width:Space.STAR_WIDTH+"px",height:Space.STAR_HEIGHT+"px"})).clone(),Space.starsBack.append(t).append(n),Space.drawStarAsync(t,n,0),Space.starsBack.data("speed",2*Space.STAR_SPEED),Space.startAnimation(Space.starsBack)},startAnimation:function(e){e.animate({bottom:"-3000px"},e.data("speed"),"linear",(function(){$(this).css("bottom","0px"),Space.startAnimation($(this))}))},drawStarAsync:function(e,a,t){var n=Math.floor(Math.random()*Space.STAR_HEIGHT)+"px",o=Math.floor(Math.random()*Space.STAR_WIDTH)+"px";$("<div>").text(".").addClass("star").css({top:n,left:o}).appendTo(e),$("<div>").text(".").addClass("star").css({top:n,left:o}).appendTo(a),t<Space.NUM_STARS&&Engine.setTimeout((function(){Space.drawStarAsync(e,a,t+1)}),100)},crash:function(){var e;Space.done||(Engine.keyLock=!0,Space.done=!0,clearInterval(Space._timer),clearInterval(Space._shipTimer),clearInterval(Space._volumeTimer),clearTimeout(Space._panelTimeout),e=Engine.isLightsOff()?"#272823":"#FFFFFF",$("body").removeClass("noMask").stop().animate({backgroundColor:e},{duration:300,progress:function(){var e=$("body").css("background-color"),a="linear-gradient(rgba"+e.substring(3,e.length-1)+", 0) 0%, rgba"+e.substring(3,e.length-1)+", 1) 100%)";$("#notifyGradient").attr("style","background-color:"+e+";background:-webkit-"+a+";background:"+a)},complete:function(){Space.stars.remove(),Space.starsBack.remove(),Space.stars=Space.starsBack=null,$("#starsContainer").remove(),$("body").attr("style",""),$("#notifyGradient").attr("style",""),$("#spacePanel").attr("style","")}}),$(".menu, select.menuBtn").animate({color:"#666"},300,"linear"),$("#outerSlider").animate({top:"0px"},300,"linear"),Engine.activeModule=Ship,Ship.onArrival(),Button.cooldown($("#liftoffButton")),Engine.event("progress","crash"),AudioEngine.playSound(AudioLibrary.CRASH))},endGame:function(){if(!Space.done){for(var e in Engine.event("progress","win"),Space.done=!0,clearInterval(Space._timer),clearInterval(Space._shipTimer),clearInterval(Space._volumeTimer),clearTimeout(Engine._saveTimer),clearTimeout(Outside._popTimeout),clearTimeout(Engine._incomeTimeout),clearTimeout(Events._eventTimeout),clearTimeout(Room._fireTimer),clearTimeout(Room._tempTimer),Room.Craftables)Room.Craftables[e].button=null;for(var a in Room.TradeGoods)Room.TradeGoods[a].button=null;delete Outside._popTimeout,AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_ENDING),$("#hullRemaining",Space.panel).animate({opacity:0},500,"linear"),Space.ship.animate({top:"350px",left:"240px"},3e3,"linear",(function(){Engine.setTimeout((function(){Space.ship.animate({top:"-100px"},200,"linear",(function(){$("#outerSlider").css({left:"0px",top:"0px"}),$("#locationSlider, #worldPanel, #spacePanel, #notifications").remove(),$("#header").empty(),Engine.setTimeout((function(){var e;$("body").stop(),e=Engine.isLightsOff()?"#EEE":"#000",$("#starsContainer").animate({opacity:0,"background-color":e},{duration:2e3,progress:function(){var e=$("body").css("background-color"),a="linear-gradient(rgba"+e.substring(3,e.length-1)+", 0) 0%, rgba"+e.substring(3,e.length-1)+", 1) 100%)";$("#notifyGradient").attr("style","background-color:"+e+";background:-webkit-"+a+";background:"+a)},complete:function(){Engine.GAME_OVER=!0,Score.save(),Prestige.save(),$("#starsContainer").remove(),$("#content, #notifications").remove(),Space.showExpansionEnding().then((()=>{Space.showEndingOptions(),Engine.options={},Engine.deleteSave(!0)}))}})}),2e3)}))}),2e3)}))}},showExpansionEnding:()=>new Promise((e=>{if(!$SM.get('stores["fleet beacon"]'))return void e();const a=$("<div>").addClass("outroContainer").appendTo("body");setTimeout((()=>{$("<div>").addClass("outro").html("the beacon pulses gently as the ship glides through space.<br>coordinates are locked. nothing to do but wait.").appendTo(a).animate({opacity:1},500)}),2e3),setTimeout((()=>{$("<div>").addClass("outro").html("the beacon glows a solid blue, and then goes dim. the ship slows.<br>gradually, the vast wanderer homefleet comes into view.<br>massive worldships drift unnaturally through clouds of debris, scarred and dead.").appendTo(a).animate({opacity:1},500)}),7e3),setTimeout((()=>{$("<div>").addClass("outro").text("the air is running out.").appendTo(a).animate({opacity:1},500)}),14e3),setTimeout((()=>{$("<div>").addClass("outro").text("the capsule is cold.").appendTo(a).animate({opacity:1},500)}),17e3),setTimeout((()=>{Button.Button({id:"wait-btn",text:_("wait"),click:t=>{t.addClass("disabled"),a.animate({opacity:0},5e3,"linear",(()=>{a.remove(),setTimeout(e,3e3)}))}}).animate({opacity:1},500).appendTo(a)}),19500)})),showEndingOptions:()=>{$("<center>").addClass("centerCont").appendTo("body"),$("<span>").addClass("endGame").text(_("score for this game: {0}",Score.calculateScore())).appendTo(".centerCont").animate({opacity:1},1500),$("<br />").appendTo(".centerCont"),$("<span>").addClass("endGame").text(_("total score: {0}",Prestige.get().score)).appendTo(".centerCont").animate({opacity:1},1500),$("<br />").appendTo(".centerCont"),$("<br />").appendTo(".centerCont"),$("<span>").addClass("endGame endGameOption").text(_("restart.")).click(Engine.confirmDelete).appendTo(".centerCont").animate({opacity:1},1500),$("<br />").appendTo(".centerCont"),$("<br />").appendTo(".centerCont"),$("<span>").addClass("endGame").text(_("expanded story. alternate ending. behind the scenes commentary. get the app.")).appendTo(".centerCont").animate({opacity:1},1500),$("<br />").appendTo(".centerCont"),$("<br />").appendTo(".centerCont"),$("<span>").addClass("endGame endGameOption").text(_("iOS.")).click((function(){window.open("https://itunes.apple.com/app/apple-store/id736683061?pt=2073437&ct=gameover&mt=8")})).appendTo(".centerCont").animate({opacity:1},1500),$("<br />").appendTo(".centerCont"),$("<span>").addClass("endGame endGameOption").text(_("android.")).click((function(){window.open("https://play.google.com/store/apps/details?id=com.yourcompany.adarkroom")})).appendTo(".centerCont").animate({opacity:1},1500)},keyDown:function(e){switch(e.which){case 38:case 87:Space.up=!0,Engine.log("up on");break;case 40:case 83:Space.down=!0,Engine.log("down on");break;case 37:case 65:Space.left=!0,Engine.log("left on");break;case 39:case 68:Space.right=!0,Engine.log("right on")}},keyUp:function(e){switch(e.which){case 38:case 87:Space.up=!1,Engine.log("up off");break;case 40:case 83:Space.down=!1,Engine.log("down off");break;case 37:case 65:Space.left=!1,Engine.log("left off");break;case 39:case 68:Space.right=!1,Engine.log("right off")}},handleStateUpdates:function(e){},lowerVolume:function(){if(!Space.done){var e=1-Space.altitude/60;AudioEngine.setBackgroundMusicVolume(e,.3)}}};