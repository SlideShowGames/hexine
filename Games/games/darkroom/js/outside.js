var Outside={name:_("Outside"),_STORES_OFFSET:0,_GATHER_DELAY:60,_TRAPS_DELAY:90,_POP_DELAY:[.5,3],_HUT_ROOM:4,_INCOME:{gatherer:{name:_("gatherer"),delay:10,stores:{wood:1}},hunter:{name:_("hunter"),delay:10,stores:{fur:.5,meat:.5}},trapper:{name:_("trapper"),delay:10,stores:{meat:-1,bait:1}},tanner:{name:_("tanner"),delay:10,stores:{fur:-5,leather:1}},charcutier:{name:_("charcutier"),delay:10,stores:{meat:-5,wood:-5,"cured meat":1}},"iron miner":{name:_("iron miner"),delay:10,stores:{"cured meat":-1,iron:1}},"coal miner":{name:_("coal miner"),delay:10,stores:{"cured meat":-1,coal:1}},"sulphur miner":{name:_("sulphur miner"),delay:10,stores:{"cured meat":-1,sulphur:1}},steelworker:{name:_("steelworker"),delay:10,stores:{iron:-1,coal:-1,steel:1}},armourer:{name:_("armourer"),delay:10,stores:{steel:-1,sulphur:-1,bullets:1}}},TrapDrops:[{rollUnder:.5,name:"fur",message:_("scraps of fur")},{rollUnder:.75,name:"meat",message:_("bits of meat")},{rollUnder:.85,name:"scales",message:_("strange scales")},{rollUnder:.93,name:"teeth",message:_("scattered teeth")},{rollUnder:.995,name:"cloth",message:_("tattered cloth")},{rollUnder:1,name:"charm",message:_("a crudely made charm")}],init:function(e){this.options=$.extend(this.options,e),Engine._debug&&(this._GATHER_DELAY=0,this._TRAPS_DELAY=0),this.tab=Header.addLocation(_("A Silent Forest"),"outside",Outside),this.panel=$("<div>").attr("id","outsidePanel").addClass("location").appendTo("div#locationSlider"),$.Dispatch("stateUpdate").subscribe(Outside.handleStateUpdates),void 0===$SM.get("features.location.outside")&&($SM.set("features.location.outside",!0),$SM.get("game.buildings")||$SM.set("game.buildings",{}),$SM.get("game.population")||$SM.set("game.population",0),$SM.get("game.workers")||$SM.set("game.workers",{})),this.updateVillage(),Outside.updateWorkersView(),Outside.updateVillageIncome(),Engine.updateSlider(),new Button.Button({id:"gatherButton",text:_("gather wood"),click:Outside.gatherWood,cooldown:Outside._GATHER_DELAY,width:"80px"}).appendTo("div#outsidePanel"),Outside.updateTrapButton()},getMaxPopulation:function(){return $SM.get('game.buildings["hut"]',!0)*Outside._HUT_ROOM},increasePopulation:function(){var e=Outside.getMaxPopulation()-$SM.get("game.population");if(e>0){var t=Math.floor(Math.random()*(e/2)+e/2);0===t&&(t=1),1==t?Notifications.notify(null,_("a stranger arrives in the night")):t<5?Notifications.notify(null,_("a weathered family takes up in one of the huts.")):t<10?Notifications.notify(null,_("a small group arrives, all dust and bones.")):t<30?Notifications.notify(null,_("a convoy lurches in, equal parts worry and hope.")):Notifications.notify(null,_("the town's booming. word does get around.")),Engine.log("population increased by "+t),$SM.add("game.population",t)}Outside.schedulePopIncrease()},killVillagers:function(e){$SM.add("game.population",-1*e),$SM.get("game.population")<0&&$SM.set("game.population",0);var t=Outside.getNumGatherers();if(t<0){var a=-t;for(var r in $SM.get("game.workers")){var i=$SM.get('game.workers["'+r+'"]');if(!(i<a)){$SM.add('game.workers["'+r+'"]',-1*a);break}a-=i,$SM.set('game.workers["'+r+'"]',0)}}},destroyHuts:function(e,t){for(var a=0,r=0;r<e;r++){var i=$SM.get("game.population",!0),o=i/Outside._HUT_ROOM,n=Math.floor(o),s=t?$SM.get('game.buildings["hut"]',!0):Math.ceil(o);if(!s)break;var d=Math.floor(Math.random()*s)+1,l=0;d<=n?l=Outside._HUT_ROOM:d==n+1&&(l=i%Outside._HUT_ROOM),$SM.set('game.buildings["hut"]',$SM.get('game.buildings["hut"]')-1),l&&(Outside.killVillagers(l),a+=l)}return a},schedulePopIncrease:function(){var e=Math.floor(Math.random()*(Outside._POP_DELAY[1]-Outside._POP_DELAY[0]))+Outside._POP_DELAY[0];Engine.log("next population increase scheduled in "+e+" minutes"),Outside._popTimeout=Engine.setTimeout(Outside.increasePopulation,60*e*1e3)},updateWorkersView:function(){var e=$("div#workers");if(e.length||0!==$SM.get("game.population")){var t=!1;0===e.length&&(t=!0,e=$("<div>").attr("id","workers").css("opacity",0));var a=$SM.get("game.population"),r=$("div#workers_row_gatherer",e);for(var i in $SM.get("game.workers")){var o=_(i),n=$SM.get('game.workers["'+i+'"]'),s=$("div#workers_row_"+i.replace(" ","-"),e);if(0===s.length){s=Outside.makeWorkerRow(i,n);var d=null;e.children().each((function(e){var t=$(this),a=t.children(".row_key").text();"gatherer"!=a&&a<o&&(d=t.attr("id"))})),null==d&&0===r.length?s.prependTo(e):null==d?s.insertAfter(r):s.insertAfter(e.find("#"+d))}else $("div#"+s.attr("id")+" > div.row_val > span",e).text(n);a-=n,0===n?($(".dnBtn",s).addClass("disabled"),$(".dnManyBtn",s).addClass("disabled")):($(".dnBtn",s).removeClass("disabled"),$(".dnManyBtn",s).removeClass("disabled"))}0===r.length?(r=Outside.makeWorkerRow("gatherer",a)).prependTo(e):$("div#workers_row_gatherer > div.row_val > span",e).text(a),0===a?($(".upBtn","#workers").addClass("disabled"),$(".upManyBtn","#workers").addClass("disabled")):($(".upBtn","#workers").removeClass("disabled"),$(".upManyBtn","#workers").removeClass("disabled")),t&&e.children().length>0&&e.appendTo("#outsidePanel").animate({opacity:1},300,"linear")}},getNumGatherers:function(){var e=$SM.get("game.population");for(var t in $SM.get("game.workers"))e-=$SM.get('game.workers["'+t+'"]');return e},makeWorkerRow:function(e,t){name=Outside._INCOME[e].name,name||(name=e);var a=$("<div>").attr("key",e).attr("id","workers_row_"+e.replace(" ","-")).addClass("workerRow");$("<div>").addClass("row_key").text(name).appendTo(a);var r=$("<div>").addClass("row_val").appendTo(a);$("<span>").text(t).appendTo(r),"gatherer"!=e&&($("<div>").addClass("upBtn").appendTo(r).click([1],Outside.increaseWorker),$("<div>").addClass("dnBtn").appendTo(r).click([1],Outside.decreaseWorker),$("<div>").addClass("upManyBtn").appendTo(r).click([10],Outside.increaseWorker),$("<div>").addClass("dnManyBtn").appendTo(r).click([10],Outside.decreaseWorker)),$("<div>").addClass("clear").appendTo(a);var i=$("<div>").addClass("tooltip bottom right").appendTo(a),o=Outside._INCOME[e];for(var n in o.stores){var s=$("<div>").addClass("storeRow");$("<div>").addClass("row_key").text(_(n)).appendTo(s),$("<div>").addClass("row_val").text(Engine.getIncomeMsg(o.stores[n],o.delay)).appendTo(s),s.appendTo(i)}return a},increaseWorker:function(e){var t=$(this).closest(".workerRow").attr("key");if(Outside.getNumGatherers()>0){var a=Math.min(Outside.getNumGatherers(),e.data);Engine.log("increasing "+t+" by "+a),$SM.add('game.workers["'+t+'"]',a)}},decreaseWorker:function(e){var t=$(this).closest(".workerRow").attr("key");if($SM.get('game.workers["'+t+'"]')>0){var a=Math.min($SM.get('game.workers["'+t+'"]')||0,e.data);Engine.log("decreasing "+t+" by "+a),$SM.add('game.workers["'+t+'"]',-1*a)}},updateVillageRow:function(e,t,a){var r="building_row_"+e.replace(" ","-"),i=_(e),o=$("div#"+r,a);if(0===o.length&&t>0){o=$("<div>").attr("id",r).addClass("storeRow"),$("<div>").addClass("row_key").text(i).appendTo(o),$("<div>").addClass("row_val").text(t).appendTo(o),$("<div>").addClass("clear").appendTo(o);var n=null;a.children().each((function(e){var t=$(this);"population"!=t.attr("id")&&(t.children(".row_key").text()<i&&(n=t.attr("id")))})),null==n?o.prependTo(a):o.insertAfter("#"+n)}else t>0?$("div#"+o.attr("id")+" > div.row_val",a).text(t):0===t&&o.remove()},updateVillage:function(e){var t,a=$("div#village"),r=$("div#population"),i=!1;for(var o in 0===a.length&&(i=!0,a=$("<div>").attr("id","village").css("opacity",0),r=$("<div>").attr("id","population").appendTo(a)),$SM.get("game.buildings"))if("trap"==o){var n=$SM.get('game.buildings["'+o+'"]'),s=$SM.get("stores.bait",!0),d=n-s;d=d<0?0:d,Outside.updateVillageRow(o,d,a),Outside.updateVillageRow("baited trap",s>n?n:s,a)}else Outside.checkWorker(o)&&Outside.updateWorkersView(),Outside.updateVillageRow(o,$SM.get('game.buildings["'+o+'"]'),a);r.text(_("pop ")+$SM.get("game.population")+"/"+this.getMaxPopulation()),0===$SM.get('game.buildings["hut"]',!0)?(t=!1,a.attr("data-legend",_("forest"))):(t=!0,a.attr("data-legend",_("village"))),i&&a.children().length>1&&(a.prependTo("#outsidePanel"),a.animate({opacity:1},300,"linear")),t&&void 0===Outside._popTimeout&&Outside.schedulePopIncrease(),this.setTitle(),!e&&Engine.activeModule===Outside&&a.children().length>1&&$("#storesContainer").css({top:a.height()+26+Outside._STORES_OFFSET+"px"})},checkWorker:function(e){var t={lodge:["hunter","trapper"],tannery:["tanner"],smokehouse:["charcutier"],"iron mine":["iron miner"],"coal mine":["coal miner"],"sulphur mine":["sulphur miner"],steelworks:["steelworker"],armoury:["armourer"]}[e],a=!1;if("object"==typeof t)for(var r=0,i=t.length;r<i;r++){var o=t[r];"number"==typeof $SM.get('game.buildings["'+e+'"]')&&"number"!=typeof $SM.get('game.workers["'+o+'"]')&&(Engine.log("adding "+o+" to the workers list"),$SM.set('game.workers["'+o+'"]',0),a=!0)}return a},updateVillageIncome:function(){for(var e in Outside._INCOME){var t=Outside._INCOME[e],a="gatherer"==e?Outside.getNumGatherers():$SM.get('game.workers["'+e+'"]');if("number"==typeof a){var r={};a<0&&(a=0);var i=$(".tooltip","div#workers_row_"+e.replace(" ","-"));i.empty();var o=!1,n=$SM.getIncome(e);for(var s in t.stores){r[s]=t.stores[s]*a,n[s]!=r[s]&&(o=!0);var d=$("<div>").addClass("storeRow");$("<div>").addClass("row_key").text(_(s)).appendTo(d),$("<div>").addClass("row_val").text(Engine.getIncomeMsg(r[s],t.delay)).appendTo(d),d.appendTo(i)}o&&$SM.setIncome(e,{delay:t.delay,stores:r})}}Room.updateIncomeView()},updateTrapButton:function(){var e=$("div#trapsButton");$SM.get('game.buildings["trap"]',!0)>0?0===e.length?new Button.Button({id:"trapsButton",text:_("check traps"),click:Outside.checkTraps,cooldown:Outside._TRAPS_DELAY,width:"80px"}).appendTo("div#outsidePanel"):Button.setDisabled(e,!1):e.length>0&&Button.setDisabled(e,!0)},setTitle:function(){var e,t=$SM.get('game.buildings["hut"]',!0);e=0===t?_("A Silent Forest"):1==t?_("A Lonely Hut"):t<=4?_("A Tiny Village"):t<=8?_("A Modest Village"):t<=14?_("A Large Village"):_("A Raucous Village"),Engine.activeModule==this&&(document.title=e),$("#location_outside").text(e)},onArrival:function(e){Outside.setTitle(),$SM.get("game.outside.seenForest")||(Notifications.notify(Outside,_("the sky is grey and the wind blows relentlessly")),$SM.set("game.outside.seenForest",!0)),Outside.updateTrapButton(),Outside.updateVillage(!0),Engine.moveStoresView($("#village"),e);var t=$SM.get('game.buildings["hut"]',!0);0===t?AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_SILENT_FOREST):1==t?AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_LONELY_HUT):t<=4?AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_TINY_VILLAGE):t<=8?AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_MODEST_VILLAGE):t<=14?AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_LARGE_VILLAGE):AudioEngine.playBackgroundMusic(AudioLibrary.MUSIC_RAUCOUS_VILLAGE)},gatherWood:function(){Notifications.notify(Outside,_("dry brush and dead branches litter the forest floor"));var e=$SM.get('game.buildings["cart"]',!0)>0?50:10;$SM.add("stores.wood",e),AudioEngine.playSound(AudioLibrary.GATHER_WOOD)},checkTraps:function(){for(var e={},t=[],a=$SM.get('game.buildings["trap"]',!0),r=$SM.get("stores.bait",!0),i=a+(r<a?r:a),o=0;o<i;o++){var n=Math.random();for(var s in Outside.TrapDrops){var d=Outside.TrapDrops[s];if(n<d.rollUnder){var l=e[d.name];void 0===l&&(l=0,t.push(d.message)),e[d.name]=l+1;break}}}for(var u=_("the traps contain "),g=0,p=t.length;g<p;g++)p>1&&g>0&&g<p-1?u+=", ":p>1&&g==p-1&&(u+=_(" and ")),u+=t[g];var c=r<a?r:a;e.bait=-c,Notifications.notify(Outside,u),$SM.addM("stores",e),AudioEngine.playSound(AudioLibrary.CHECK_TRAPS)},handleStateUpdates:function(e){"stores"==e.category?Outside.updateVillage():0!==e.stateName.indexOf("game.workers")&&0!==e.stateName.indexOf("game.population")||(Outside.updateVillage(),Outside.updateWorkersView(),Outside.updateVillageIncome())}};