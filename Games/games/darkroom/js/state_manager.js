var StateManager={MAX_STORE:99999999999999,options:{},init:function(e){this.options=$.extend(this.options,e);var t=["features","stores","character","income","timers","game","playStats","previous","outfit","config","wait","cooldown"];for(var a in t)$SM.get(t[a])||$SM.set(t[a],{});$.Dispatch("stateUpdate").subscribe($SM.handleStateUpdates)},createState:function(e,t){for(var a=e.split(/[.\[\]'"]+/),o=0;o<a.length;o++)""===a[o]&&(a.splice(o,1),o--);for(var r=State,n=null,s=0,i=a.length-1;s<i;s++)void 0===r[n=a[s]]&&(r[n]={}),r=r[n];return r[a[s]]=t,r},set:function(stateName,value,noEvent){var fullPath=$SM.buildPath(stateName);"number"==typeof value&&value>$SM.MAX_STORE&&(value=$SM.MAX_STORE);try{eval("("+fullPath+") = value")}catch(e){$SM.createState(stateName,value)}0===stateName.indexOf("stores")&&$SM.get(stateName,!0)<0&&(eval("("+fullPath+") = 0"),Engine.log("WARNING: state:"+stateName+" can not be a negative value. Set to 0 instead.")),noEvent||(Engine.saveGame(),$SM.fireUpdate(stateName))},setM:function(e,t,a){for(var o in $SM.buildPath(e),void 0===$SM.get(e)&&$SM.set(e,{},!0),t)$SM.set(e+'["'+o+'"]',t[o],!0);a||(Engine.saveGame(),$SM.fireUpdate(e))},add:function(e,t,a){var o=0,r=$SM.get(e,!0);return r!=r?(Engine.log("WARNING: "+e+" was corrupted (NaN). Resetting to 0."),r=0,$SM.set(e,r+t,a)):"number"!=typeof r||"number"!=typeof t?(Engine.log("WARNING: Can not do math with state:"+e+" or value:"+t+" because at least one is not a number."),o=1):$SM.set(e,r+t,a),o},addM:function(e,t,a){var o=0;for(var r in void 0===$SM.get(e)&&$SM.set(e,{},!0),t)$SM.add(e+'["'+r+'"]',t[r],!0)&&o++;return a||(Engine.saveGame(),$SM.fireUpdate(e)),o},get:function(stateName,requestZero){var whichState=null,fullPath=$SM.buildPath(stateName);try{eval("whichState = ("+fullPath+")")}catch(e){whichState=void 0}return whichState&&whichState!={}||!requestZero?whichState:0},setget:function(stateName,value,noEvent){return $SM.set(stateName,value,noEvent),eval("("+$SM.buildPath(stateName)+")")},remove:function(stateName,noEvent){var whichState=$SM.buildPath(stateName);try{eval("(delete "+whichState+")")}catch(e){Engine.log("WARNING: Tried to remove non-existant state '"+stateName+"'.")}noEvent||(Engine.saveGame(),$SM.fireUpdate(stateName))},removeBranch:function(e,t){for(var a in $SM.get(e))"object"==typeof $SM.get(e)[a]&&$SM.removeBranch(e+'["'+a+'"]');$.isEmptyObject($SM.get(e))&&$SM.remove(e),t||(Engine.saveGame(),$SM.fireUpdate(e))},buildPath:function(e){return"State"+("["==e.charAt(0)?"":".")+e},fireUpdate:function(e,t){var a=$SM.getCategory(e);void 0===e&&(e=a="all"),$.Dispatch("stateUpdate").publish({category:a,stateName:e}),t&&Engine.saveGame()},getCategory:function(e){var t=e.indexOf("["),a=e.indexOf("."),o=null;return-1==(o=-1==t||-1==a?t>a?t:a:t<a?t:a)?e:e.substr(0,o)},updateOldState:function(){var e=$SM.get("version");"number"!=typeof e&&(e=1),1==e&&($SM.remove("outside.workers.hunter",!0),$SM.remove("income.hunter",!0),Engine.log("upgraded save to v1.1"),e=1.1),1.1==e&&($SM.get("world")&&World.placeLandmark(15,1.5*World.RADIUS,World.TILE.SWAMP,$SM.get("world.map")),Engine.log("upgraded save to v1.2"),e=1.2),1.2==e&&($SM.remove("room.fire"),$SM.remove("room.temperature"),$SM.remove("room.buttons"),$SM.get("room")&&($SM.set("features.location.room",!0),$SM.set("game.builder.level",$SM.get("room.builder")),$SM.remove("room")),$SM.get("outside")&&($SM.set("features.location.outside",!0),$SM.set("game.population",$SM.get("outside.population")),$SM.set("game.buildings",$SM.get("outside.buildings")),$SM.set("game.workers",$SM.get("outside.workers")),$SM.set("game.outside.seenForest",$SM.get("outside.seenForest")),$SM.remove("outside")),$SM.get("world")&&($SM.set("features.location.world",!0),$SM.set("game.world.map",$SM.get("world.map")),$SM.set("game.world.mask",$SM.get("world.mask")),$SM.set("starved",$SM.get("character.starved",!0)),$SM.set("dehydrated",$SM.get("character.dehydrated",!0)),$SM.remove("world"),$SM.remove("starved"),$SM.remove("dehydrated")),$SM.get("ship")&&($SM.set("features.location.spaceShip",!0),$SM.set("game.spaceShip.hull",$SM.get("ship.hull",!0)),$SM.set("game.spaceShip.thrusters",$SM.get("ship.thrusters",!0)),$SM.set("game.spaceShip.seenWarning",$SM.get("ship.seenWarning")),$SM.set("game.spaceShip.seenShip",$SM.get("ship.seenShip")),$SM.remove("ship")),$SM.get("punches")&&($SM.set("character.punches",$SM.get("punches")),$SM.remove("punches")),$SM.get("perks")&&($SM.set("character.perks",$SM.get("perks")),$SM.remove("perks")),$SM.get("thieves")&&($SM.set("game.thieves",$SM.get("thieves")),$SM.remove("thieves")),$SM.get("stolen")&&($SM.set("game.stolen",$SM.get("stolen")),$SM.remove("stolen")),$SM.get("cityCleared")&&($SM.set("character.cityCleared",$SM.get("cityCleared")),$SM.remove("cityCleared")),$SM.set("version",1.3))},addPerk:function(e){$SM.set('character.perks["'+e+'"]',!0),Notifications.notify(null,Engine.Perks[e].notify)},hasPerk:function(e){return $SM.get('character.perks["'+e+'"]')},setIncome:function(e,t){var a=$SM.get('income["'+e+'"]');void 0!==a&&(t.timeLeft=a.timeLeft),$SM.set('income["'+e+'"]',t)},getIncome:function(e){var t=$SM.get('income["'+e+'"]');return void 0!==t?t:{}},collectIncome:function(){var e=!1;if(void 0!==$SM.get("income")&&Engine.activeModule!=Space)for(var t in $SM.get("income")){var a=$SM.get('income["'+t+'"]');if("number"!=typeof a.timeLeft&&(a.timeLeft=0),a.timeLeft--,a.timeLeft<=0){Engine.log("collection income from "+t),"thieves"==t&&$SM.addStolen(a.stores);var o=a.stores,r=!0;if("thieves"!=t)for(var n in o){if($SM.get('stores["'+n+'"]',!0)+o[n]<0){r=!1;break}}r&&$SM.addM("stores",a.stores,!0),e=!0,"number"==typeof a.delay&&(a.timeLeft=a.delay)}}e&&$SM.fireUpdate("income",!0),Engine._incomeTimeout=Engine.setTimeout($SM.collectIncome,1e3)},addStolen:function(e){for(var t in e){var a=$SM.get('stores["'+t+'"]',!0)+e[t];a<0?$SM.add('game.stolen["'+t+'"]',-1*e[t]+a):$SM.add('game.stolen["'+t+'"]',-1*e[t])}},startThieves:function(){$SM.set("game.thieves",1),$SM.setIncome("thieves",{delay:10,stores:{wood:-10,fur:-5,meat:-5}})},num:function(e,t){switch(t.type){case"good":case"tool":case"weapon":case"upgrade":case"special":return $SM.get('stores["'+e+'"]',!0);case"building":return $SM.get('game.buildings["'+e+'"]',!0)}},handleStateUpdates:function(e){}},$SM=StateManager;