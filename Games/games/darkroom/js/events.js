var Events={_EVENT_TIME_RANGE:[3,6],_PANEL_FADE:200,_FIGHT_SPEED:100,_EAT_COOLDOWN:5,_MEDS_COOLDOWN:7,_HYPO_COOLDOWN:7,_SHIELD_COOLDOWN:10,_STIM_COOLDOWN:10,_LEAVE_COOLDOWN:1,STUN_DURATION:4e3,ENERGISE_MULTIPLIER:4,EXPLOSION_DURATION:3e3,ENRAGE_DURATION:4e3,MEDITATE_DURATION:5e3,BOOST_DURATION:3e3,BOOST_DAMAGE:10,DOT_TICK:1e3,BLINK_INTERVAL:!1,init:function(t){this.options=$.extend(this.options,t),Events.EventPool=[].concat(Events.Global,Events.Room,Events.Outside,Events.Marketing),Events.eventStack=[],Events.scheduleNextEvent(),$.Dispatch("stateUpdate").subscribe(Events.handleStateUpdates),Events.initDelay()},options:{},delayState:"wait",activeScene:null,loadScene:function(t){Engine.log("loading scene: "+t),Events.activeScene=t;var e=Events.activeEvent().scenes[t];e.onLoad&&e.onLoad(),e.notification&&Notifications.notify(null,e.notification),e.reward&&$SM.addM("stores",e.reward),$("#description",Events.eventPanel()).empty(),$("#buttons",Events.eventPanel()).empty(),e.combat?Events.startCombat(e):Events.startStory(e)},startCombat:function(t){Engine.event("game event","combat"),Events.fought=!1,Events.won=!1;var e=$("#description",Events.eventPanel());$("<div>").text(t.notification).appendTo(e);var n=$("<div>").attr("id","fight").appendTo(e);Events.createFighterDiv("@",World.health,World.getMaxHealth()).attr("id","wanderer").appendTo(n),Events.createFighterDiv(t.chara,t.health,t.health).attr("id","enemy").appendTo(n);var a=$("#buttons",Events.eventPanel()),o=$("<div>").appendTo(a).attr("id","attackButtons"),s=0;for(var i in World.Weapons){var r=World.Weapons[i];if("number"==typeof Path.outfit[i]&&Path.outfit[i]>0){if("number"!=typeof r.damage||0===r.damage)s--;else if(r.cost)for(var d in r.cost){var v=r.cost[d];("number"!=typeof Path.outfit[d]||Path.outfit[d]<v)&&s--}s++,Events.createAttackButton(i).appendTo(o)}}0===s&&Events.createAttackButton("fists").prependTo(o),$("<div>").addClass("clear").appendTo(o);var l=$("<div>").appendTo(a).attr("id","healButtons");Events.createEatMeatButton().appendTo(l),0!==(Path.outfit.medicine||0)&&Events.createUseMedsButton().appendTo(l),0!==(Path.outfit.hypo||0)&&Events.createUseHypoButton().appendTo(l),(Path.outfit.stim??0)>0&&Events.createStimButton().appendTo(l),$SM.get('stores["kinetic armour"]',!0)>0&&Events.createShieldButton().appendTo(l),$("<div>").addClass("clear").appendTo(l),Events.setHeal(l),Events.startEnemyAttacks(),Events._specialTimers=(t.specials??[]).map((t=>Engine.setInterval((()=>{const e=$("#enemy"),n=t.action(e);Events.updateFighterDiv(e),n&&Events.drawFloatText(n,$(".hp",e))}),1e3*t.delay)))},startEnemyAttacks:t=>{clearInterval(Events._enemyAttackTimer);const e=Events.activeEvent().scenes[Events.activeScene];Events._enemyAttackTimer=Engine.setInterval(Events.enemyAttack,1e3*(t??e.attackDelay))},setStatus:(t,e)=>{t.data("status",e),"enraged"===e&&"enemy"===t.attr("id")&&(Events.startEnemyAttacks(.5),setTimeout((()=>{t.data("status","none"),Events.startEnemyAttacks()}),Events.ENRAGE_DURATION)),"meditation"===e&&(Events._meditateDmg=0,setTimeout((()=>{t.data("status","none")}),Events.MEDITATE_DURATION)),"boost"===e&&setTimeout((()=>{t.data("status","none")}),Events.BOOST_DURATION)},setPause:function(t,e){t||(t=$("#pause"));var n,a,o=t.closest("#event");"set"==e?(n="start.",a="loaded"):(n="resume.",a="paused"),t.children(".text").first().text(_(n)),Events.paused="auto"!=e||"auto",o.addClass("paused"),Button.clearCooldown(t),$("#buttons").find(".button").each((function(t){$(this).data("onCooldown")&&$(this).children(".cooldown").stop(!0,!1)})),Engine.log("fight "+a+".")},removePause:function(t,e){t||(t=$("#pause"));var n,a,o,s=t.closest("#event");if("auto"!=e||"auto"==Events.paused){switch(e){case"set":Button.cooldown(t,Events._LEAVE_COOLDOWN),n="started",a=1e3*Events._LEAVE_COOLDOWN,o=$();break;case"end":Button.setDisabled(t,!0),n="ended",a=Events._FIGHT_SPEED,o=$();break;case"auto":Button.cooldown(t);default:n="resumed",a=1e3*Events._PAUSE_COOLDOWN,o=$("#buttons").find(".button")}Engine.setTimeout((function(){t.children(".text").first().text(_("pause.")),Events.paused=!1,s.removeClass("paused"),o.each((function(t){$(this).data("onCooldown")&&Button.cooldown($(this),"pause")})),Engine.log("Event "+n)}),a)}},togglePause:function(t,e){(t||(t=$("#pause")),e&&document.hasFocus()==!Events.paused)||(Events.paused?Events.removePause:Events.setPause)(t,!!e&&"auto")},createEatMeatButton:function(t){null==t&&(t=Events._EAT_COOLDOWN);var e=new Button.Button({id:"eat",text:_("eat meat"),cooldown:t,click:Events.eatMeat,cost:{"cured meat":1}});return 0===Path.outfit["cured meat"]&&Button.setDisabled(e,!0),e},createUseMedsButton:function(t){null==t&&(t=Events._MEDS_COOLDOWN);var e=new Button.Button({id:"meds",text:_("use meds"),cooldown:t,click:Events.useMeds,cost:{medicine:1}});return 0===(Path.outfit.medicine||0)&&Button.setDisabled(e,!0),e},createUseHypoButton:function(t){null==t&&(t=Events._HYPO_COOLDOWN);var e=new Button.Button({id:"hypo",text:_("use hypo"),cooldown:t,click:Events.useHypo,cost:{hypo:1}});return(Path.outfit.hypo??0)>0&&Button.setDisabled(e,!0),e},createShieldButton:function(){return new Button.Button({id:"shld",text:_("shield"),cooldown:Events._SHIELD_COOLDOWN,click:Events.useShield})},createStimButton:()=>new Button.Button({id:"use-stim",text:_("boost"),cooldown:Events._STIM_COOLDOWN,click:Events.useStim}),createAttackButton:function(t){var e=World.Weapons[t],n=e.cooldown;"unarmed"==e.type&&$SM.hasPerk("unarmed master")&&(n/=2);var a=new Button.Button({id:"attack_"+t.replace(/ /g,"-"),text:e.verb,cooldown:n,click:Events.useWeapon,boosted:()=>"boost"===$("#wanderer").data("status"),cost:e.cost});for(var o in"number"==typeof e.damage&&e.damage>0&&a.addClass("weaponButton"),e.cost)if("number"!=typeof Path.outfit[o]||Path.outfit[o]<e.cost[o]){Button.setDisabled(a,!0);break}return a},drawFloatText:function(t,e,n){$("<div>").text(t).addClass("damageText").appendTo(e).animate({bottom:"70px",opacity:"0"},700,"linear",(function(){$(this).remove(),n&&n()}))},setHeal:function(t){t||(t=$("#healButtons")),t=t.children(".button");var e=World.health<World.getMaxHealth();return t.each((function(t){const n=$(this);Button.setDisabled(n,!e&&"shld"!==n.attr("id"))})),e},doHeal:function(t,e,n){if(Path.outfit[t]>0){Path.outfit[t]--,World.updateSupplies(),0===Path.outfit[t]&&Button.setDisabled(n,!0);var a=World.health+e;if(a=Math.min(World.getMaxHealth(),a),World.setHp(a),Events.setHeal(),Events.activeEvent()){var o=$("#wanderer");o.data("hp",a),Events.updateFighterDiv(o),Events.drawFloatText("+"+e,"#wanderer .hp");var s=Events.setTakeAll();Events.canLeave(s)}}},eatMeat:function(t){Events.doHeal("cured meat",World.meatHeal(),t),AudioEngine.playSound(AudioLibrary.EAT_MEAT)},useMeds:function(t){Events.doHeal("medicine",World.medsHeal(),t),AudioEngine.playSound(AudioLibrary.USE_MEDS)},useHypo:t=>{Events.doHeal("hypo",World.hypoHeal(),t),AudioEngine.playSound(AudioLibrary.USE_MEDS)},useShield:t=>{const e=$("#wanderer");e.data("status","shield"),Events.updateFighterDiv(e)},useStim:t=>{const e=$("#wanderer");e.data("status","boost"),Events.dotDamage(e,Events.BOOST_DAMAGE),Events.updateFighterDiv(e)},useWeapon:function(t){if(Events.activeEvent()){var e=t.attr("id").substring(7).replace(/-/g," "),n=World.Weapons[e];if("unarmed"==n.type&&($SM.get("character.punches")||$SM.set("character.punches",0),$SM.add("character.punches",1),50!=$SM.get("character.punches")||$SM.hasPerk("boxer")?150!=$SM.get("character.punches")||$SM.hasPerk("martial artist")?300!=$SM.get("character.punches")||$SM.hasPerk("unarmed master")||$SM.addPerk("unarmed master"):$SM.addPerk("martial artist"):$SM.addPerk("boxer")),n.cost){var a={},o=!1;for(var s in n.cost){if("number"!=typeof Path.outfit[s]||Path.outfit[s]<n.cost[s])return;a[s]=-n.cost[s],Path.outfit[s]-n.cost[s]<n.cost[s]&&(o=!0)}for(var i in a)Path.outfit[i]+=a[i];if(o){Button.setDisabled(t,!0);var r=!1;if($(".weaponButton").each((function(){if(!Button.isDisabled($(this))&&"attack_fists"!=$(this).attr("id"))return r=!0,!1})),!r){var d=$("#attack_fists");0===d.length?Events.createAttackButton("fists").prependTo("#buttons",Events.eventPanel()):Button.setDisabled(d,!1)}}World.updateSupplies()}var v=-1;Math.random()<=World.getHitChance()&&"number"==typeof(v=n.damage)&&("unarmed"==n.type&&$SM.hasPerk("boxer")&&(v*=2),"unarmed"==n.type&&$SM.hasPerk("martial artist")&&(v*=3),"unarmed"==n.type&&$SM.hasPerk("unarmed master")&&(v*=2),"melee"==n.type&&$SM.hasPerk("barbarian")&&(v=Math.floor(1.5*v)));var l="ranged"==n.type?Events.animateRanged:Events.animateMelee,u=Math.floor(2*Math.random())+1;switch(n.type){case"unarmed":AudioEngine.playSound(AudioLibrary["WEAPON_UNARMED_"+u]);break;case"melee":AudioEngine.playSound(AudioLibrary["WEAPON_MELEE_"+u]);break;case"ranged":AudioEngine.playSound(AudioLibrary["WEAPON_RANGED_"+u])}l($("#wanderer"),v,(function(){const t=$("#enemy"),e=t.data("hp"),n=Events.activeEvent().scenes[Events.activeScene],a=n.atHealth??{},o=n.explosion;for(const[n,o]of Object.entries(a)){const a=Number(n);e<=a&&e+v>a&&o(t)}e<=0&&!Events.won&&(Events.won=!0,o?Events.explode(t,$("#wanderer"),o):Events.winFight())}))}},explode:(t,e,n)=>{Events.clearTimeouts(),t.addClass("exploding"),setTimeout((()=>{t.removeClass("exploding"),$(".label",t).text("*"),Events.damage(t,e,n,"ranged",(()=>{Events.checkPlayerDeath()||Events.winFight()}))}),Events.EXPLOSION_DURATION)},dotDamage:(t,e)=>{const n=Math.max(0,t.data("hp")-e);t.data("hp",n),"wanderer"==t.attr("id")?(World.setHp(n),Events.setHeal(),Events.checkPlayerDeath()):n<=0&&!Events.won&&(Events.won=!0,Events.winFight()),Events.updateFighterDiv(t),Events.drawFloatText(`-${e}`,$(".hp",t))},damage:function(t,e,n,a,o){var s=e.data("hp");const i=e.data("maxHp");var r="";const d="shield"===e.data("status"),v="energised"===t.data("status"),l="venomous"===t.data("status"),u="meditation"===e.data("status");if("number"==typeof n)if(n<0)r=_("miss"),n=0;else{v&&(n*=this.ENERGISE_MULTIPLIER),u?(Events._meditateDmg=(Events._meditateDmg??0)+n,r=n):(r=(d?"+":"-")+n,s=Math.min(i,Math.max(0,s+(d?n:-n))),e.data("hp",s),"enemy"==t.attr("id")&&(World.setHp(s),Events.setHeal())),l&&!d&&(clearInterval(Events._dotTimer),Events._dotTimer=setInterval((()=>{Events.dotDamage(e,Math.floor(n/2))}),Events.DOT_TICK)),d&&e.data("status","none"),Events.updateFighterDiv(e);var c=Math.floor(2*Math.random())+1;switch(a){case"unarmed":AudioEngine.playSound(AudioLibrary["WEAPON_UNARMED_"+c]);break;case"melee":AudioEngine.playSound(AudioLibrary["WEAPON_MELEE_"+c]);break;case"ranged":AudioEngine.playSound(AudioLibrary["WEAPON_RANGED_"+c])}}else"stun"==n&&(r=_("stunned"),e.data("stunned",!0),setTimeout((()=>e.data("stunned",!1)),Events.STUN_DURATION));(v||l)&&(t.data("status","none"),Events.updateFighterDiv(t)),Events.drawFloatText(r,$(".hp",e),o)},animateMelee:function(t,e,n){var a,o,s;"wanderer"==t.attr("id")?(a={left:"50%"},o={left:"25%"},s=$("#enemy")):(a={right:"50%"},o={right:"25%"},s=$("#wanderer")),t.stop(!0,!0).animate(a,Events._FIGHT_SPEED,(function(){Events.damage(t,s,e,"melee"),$(this).animate(o,Events._FIGHT_SPEED,n)}))},animateRanged:function(t,e,n){var a,o,s;"wanderer"==t.attr("id")?(a={left:"25%"},o={left:"50%"},s=$("#enemy")):(a={right:"25%"},o={right:"50%"},s=$("#wanderer")),$("<div>").css(a).addClass("bullet").text("o").appendTo("#description").animate(o,2*Events._FIGHT_SPEED,"linear",(function(){Events.damage(t,s,e,"ranged"),$(this).remove(),"function"==typeof n&&n()}))},enemyAttack:function(){var t=Events.activeEvent().scenes[Events.activeScene];const e=$("#enemy"),n=e.data("stunned"),a="meditation"===e.data("status");if(!n&&!a){var o=t.hit;o*=$SM.hasPerk("evasive")?.8:1;var s=-1;(Events._meditateDmg??0)>0?(s=Events._meditateDmg,Events._meditateDmg=0):Math.random()<=o&&(s=t.damage),(t.ranged?Events.animateRanged:Events.animateMelee)($("#enemy"),s,Events.checkPlayerDeath)}},checkPlayerDeath:()=>$("#wanderer").data("hp")<=0&&(Events.clearTimeouts(),Events.endEvent(),World.die(),!0),clearTimeouts:()=>{clearInterval(Events._enemyAttackTimer),Events._specialTimers.forEach(clearInterval),clearInterval(Events._dotTimer)},endFight:function(){Events.fought=!0,Events.clearTimeouts(),Events.removePause($("#pause"),"end")},winFight:function(){Engine.setTimeout((function(){Events.fought||(Events.endFight(),$("#enemy").animate({opacity:0},300,"linear",(function(){Engine.setTimeout((function(){var t=Events.activeEvent().scenes[Events.activeScene],e=!1,n=$("#description",Events.eventPanel()),a=$("#buttons",Events.eventPanel());n.empty(),a.empty(),$("<div>").text(t.deathMessage).appendTo(n);var o=Events.drawLoot(t.loot),s=$("<div>").appendTo(a).attr("id","exitButtons");if(t.buttons)e=Events.drawButtons(t);else{e=new Button.Button({id:"leaveBtn",cooldown:Events._LEAVE_COOLDOWN,click:function(){t.nextScene&&"end"!=t.nextScene?Events.loadScene(t.nextScene):Events.endEvent()},text:_("leave")}),Button.cooldown(e.appendTo(s));var i=$("<div>").appendTo(a).attr("id","healButtons");Events.createEatMeatButton(0).appendTo(i),0!==(Path.outfit.medicine||0)&&Events.createUseMedsButton(0).appendTo(i),Path.outfit.hypo&&Events.createUseHypoButton(0).appendTo(i),$("<div>").addClass("clear").appendTo(i),Events.setHeal(i)}$("<div>").addClass("clear").appendTo(s),Events.allowLeave(o,e)}),1e3,!0)})))}),Events._FIGHT_SPEED)},loseFight:function(){Events.endFight(),Events.endEvent(),World.die()},drawDrop:function(t){var e=t.attr("id").substring(5).replace(/-/g," "),n=!1,a=Path.getWeight(e),o=Path.getFreeSpace();if(a>o){var s;for(var i in Engine.log("drop menu"),$("#dropMenu").length?(s=$("#dropMenu"),$("#dropMenu").empty()):(s=$("<div>").attr({id:"dropMenu","data-legend":_("drop:")}),n=!0),Path.outfit)if(e!=i){var r=Path.getWeight(i);if(r>0){var d=Math.ceil((a-o)/r);if(d>Path.outfit[i]&&(d=Path.outfit[i]),d>0)$("<div>").attr("id","drop_"+i.replace(/ /g,"-")).text(_(i)+" x"+d).data("thing",i).data("num",d).click(Events.dropStuff).mouseenter((function(t){t.stopPropagation()})).appendTo(s)}}$("<div>").attr("id","no_drop").text(_("nothing")).mouseenter((function(t){t.stopPropagation()})).click((function(t){t.stopPropagation(),s.remove()})).appendTo(s),n&&s.appendTo(t),t.one("mouseleave",(function(){$("#dropMenu").remove()}))}},drawLootRow:function(t,e){var n=t.replace(/ /g,"-"),a=$("<div>").attr("id","loot_"+n).data("item",t).addClass("lootRow"),o=new Button.Button({id:"take_"+n,text:_(t)+" ["+e+"]",click:Events.getLoot}).addClass("lootTake").data("numLeft",e).appendTo(a);o.mouseenter((function(){Events.drawDrop(o)}));var s=new Button.Button({id:"all_take_"+n,text:_("take")+" ",click:Events.takeAll}).addClass("lootTakeAll").appendTo(a);return $("<span>").insertBefore(s.children(".cooldown")),$("<div>").addClass("clear").appendTo(a),a},drawLoot:function(t){var e=$("#description",Events.eventPanel()),n=$("<div>").attr({id:"lootButtons","data-legend":_("take:")});for(var a in t){var o=t[a];if(Math.random()<o.chance){var s=Math.floor(Math.random()*(o.max-o.min))+o.min;Events.drawLootRow(a,s).appendTo(n)}}n.appendTo(e);var i=null;if(n.children().length>0){var r=$("<div>").addClass("takeETrow");i=new Button.Button({id:"loot_takeEverything",text:"",cooldown:Events._LEAVE_COOLDOWN,click:Events.takeEverything}).appendTo(r),$("<span>").insertBefore(i.children(".cooldown")),$("<div>").addClass("clear").appendTo(r),r.appendTo(n),Events.setTakeAll(n)}else{$("<div>").addClass("noLoot").text(_("nothing to take")).appendTo(n)}return i||!1},setTakeAll:function(t){t||(t=$("#lootButtons"));var e=!1,n=Path.getFreeSpace(),a=t.find("#loot_takeEverything");return t.children(".lootRow").each((function(t){var a=$(this).data("item"),o=$(this).children(".lootTake").first(),s=$(this).children(".lootTakeAll").first(),i=o.data("numLeft"),r=Math.min(Math.floor(Path.getFreeSpace()/Path.getWeight(a)),i);s.data("numLeft",r),n-=i*Path.getWeight(a),r>0?(s.removeClass("disabled"),e=!0):s.addClass("disabled"),r<i?s.children("span").first().text(r):s.children("span").first().text(_("all"))})),Button.setDisabled(a,!e),a.data("canTakeEverything",n>=0),a},allowLeave:function(t,e){t&&(e&&t.data("leaveBtn",e),Events.canLeave(t))},canLeave:function(t){var e=t.data("canTakeEverything")?_("take everything"):_("take all you can"),n=t.children("span"),a=!!t.data("leaveBtn")&&t.data("canTakeEverything"),o=_(e);a&&(Button.cooldown(t),o+=_(" and ")+t.data("leaveBtn").text()),n.text(o),t.data("canLeave",a)},dropStuff:function(t){t.stopPropagation();var e=$(this),n=e.closest(".button"),a=e.data("thing"),o="take_"+a.replace(/ /g,"-"),s=e.data("num"),i=$("#lootButtons");Engine.log("dropping "+s+" "+a);var r=$("#"+o,i);if(r.length>0){var d=r.data("numLeft");d+=s,r.text(_(a)+" ["+d+"]").data("numLeft",d)}else{Events.drawLootRow(a,s).insertBefore($(".takeETrow",i))}Path.outfit[a]-=s,Events.getLoot(n),World.updateSupplies()},getLoot:function(t,e){var n=t.attr("id").substring(5).replace(/-/g," ");if(t.data("numLeft")>0){var a=e||!1;if(Path.getWeight(n)<=Path.getFreeSpace()){var o=t.data("numLeft");o--,t.data("numLeft",o),t.text(_(n)+" ["+o+"]"),0===o&&(Button.setDisabled(t),t.animate({opacity:0},300,"linear",(function(){$(this).parent().remove(),1==$("#lootButtons").children().length&&$("#lootButtons").remove()})));var s=Path.outfit[n];s="number"==typeof s?s:0,s++,Path.outfit[n]=s,World.updateSupplies(),a||Events.setTakeAll()}a||Events.drawDrop(t)}},takeAll:function(t){for(var e=$("#"+t.attr("id").substring(4)),n=0;n<t.data("numLeft");n++)Events.getLoot(e,!0);Events.setTakeAll()},takeEverything:function(t){$("#lootButtons").children(".lootRow").each((function(t){var e=$(this).children(".lootTakeAll").first();e.hasClass("disabled")||Events.takeAll(e)})),t.data("canLeave")&&t.data("leaveBtn").click()},createFighterDiv:function(t,e,n){var a=$("<div>").addClass("fighter").data("hp",e).data("maxHp",n).data("refname",t);return $("<div>").addClass("label").text(_(t)).appendTo(a),$("<div>").addClass("hp").text(e+"/"+n).appendTo(a),a},updateFighterDiv:function(t){$(".hp",t).text(t.data("hp")+"/"+t.data("maxHp"));const e=t.data("status"),n=e&&"none"!==e;t.attr("class","fighter"+(n?` ${e}`:""))},startStory:function(t){var e,n,a=$("#description",Events.eventPanel());for(var o in t.text)$("<div>").text(t.text[o]).appendTo(a);if(null!=t.textarea){var s=$("<textarea>").val(t.textarea).appendTo(a);t.readonly&&s.attr("readonly",!0),Engine.autoSelect("#description textarea")}t.loot&&(n=Events.drawLoot(t.loot));var i=$("<div>").attr("id","exitButtons").appendTo($("#buttons",Events.eventPanel()));e=Events.drawButtons(t),$("<div>").addClass("clear").appendTo(i),Events.allowLeave(n,e)},drawButtons:function(t){var e=$("#exitButtons",Events.eventPanel()),n=[];for(var a in t.buttons){var o=t.buttons[a];const i={...o.cost};Path.outfit&&Path.outfit.glowstone&&delete i.torch;var s=new Button.Button({id:a,text:o.text,cost:i,click:Events.buttonClick,cooldown:o.cooldown}).appendTo(e);"function"!=typeof o.available||o.available()||Button.setDisabled(s,!0),"number"==typeof o.cooldown&&Button.cooldown(s),n.push(s)}return Events.updateButtons(),1==n.length&&n[0]},getQuantity:function(t){if("water"===t)return World.water;if("hp"===t)return World.health;var e=Engine.activeModule==World?Path.outfit[t]:$SM.get('stores["'+t+'"]',!0);return isNaN(e)||e<0?0:e},updateButtons:function(){var t=Events.activeEvent().scenes[Events.activeScene].buttons;for(var e in t){var n=t[e],a=$("#"+e,Events.eventPanel());if("function"!=typeof n.available||n.available()){if(n.cost){const t={...n.cost};Path.outfit&&Path.outfit.glowstone&&delete t.torch;var o=!1;for(var s in t){if(Events.getQuantity(s)<t[s]){o=!0;break}}Button.setDisabled(a,o)}}else Button.setDisabled(a,!0)}},buttonClick:function(t){var e=Events.activeEvent().scenes[Events.activeScene].buttons[t.attr("id")],n={};if(e.cost){const t={...e.cost};for(var a in Path.outfit&&Path.outfit.glowstone&&delete t.torch,t){if(Events.getQuantity(a)<t[a])return;"water"===a?World.setWater(World.water-t[a]):"hp"===a?World.setHp(World.hp-t[a]):n[a]=-t[a]}if(Engine.activeModule==World){for(var o in n)Path.outfit[o]+=n[o];World.updateSupplies()}else $SM.addM("stores",n)}if("function"==typeof e.onChoose){var s=Events.eventPanel().find("textarea");e.onChoose(s.length>0?s.val():null)}if(e.reward&&$SM.addM("stores",e.reward),Events.updateButtons(),e.notification&&Notifications.notify(null,e.notification),e.onClick&&e.onClick(),e.link)return Events.endEvent(),void window.open(e.link);if(e.nextEvent){const t=Events.Setpieces[e.nextEvent]||Events.Executioner[e.nextEvent];Events.switchEvent(t)}else if(e.nextScene)if("end"==e.nextScene)Events.endEvent();else{var i=Math.random(),r=null;for(var d in e.nextScene)i<d&&(null==r||d<r)&&(r=d);if(null!=r)return void Events.loadScene(e.nextScene[r]);Engine.log("ERROR: no suitable scene found"),Events.endEvent()}},blinkTitle:function(){var t=document.title;Events.BLINK_INTERVAL=setInterval((function(){document.title=_("*** EVENT ***"),Engine.setTimeout((function(){document.title=t}),1500,!0)}),3e3)},stopTitleBlink:function(){clearInterval(Events.BLINK_INTERVAL),Events.BLINK_INTERVAL=!1},triggerEvent:function(){if(null==Events.activeEvent()){var t=[];for(var e in Events.EventPool){var n=Events.EventPool[e];n.isAvailable()&&t.push(n)}if(0===t.length)return void Events.scheduleNextEvent(.5);var a=Math.floor(Math.random()*t.length);Events.startEvent(t[a])}Events.scheduleNextEvent()},triggerFight:function(){var t=[];for(var e in Events.Encounters){var n=Events.Encounters[e];n.isAvailable()&&t.push(n)}var a=Math.floor(Math.random()*t.length);Events.startEvent(t[a]),t.length>0&&(World.getDistance()>20?AudioEngine.playEventMusic(AudioLibrary.ENCOUNTER_TIER_3):World.getDistance()>10?AudioEngine.playEventMusic(AudioLibrary.ENCOUNTER_TIER_2):AudioEngine.playEventMusic(AudioLibrary.ENCOUNTER_TIER_1))},activeEvent:function(){return Events.eventStack&&Events.eventStack.length>0?Events.eventStack[0]:null},eventPanel:function(){return Events.activeEvent().eventPanel},switchEvent:t=>{t&&(AudioEngine.stopEventMusic(),Events.eventPanel().remove(),Events.activeEvent().eventPanel=null,Events.eventStack.shift(),Events.startEvent(t))},startEvent:function(t,e){t&&(t.audio&&AudioEngine.playEventMusic(t.audio),Engine.event("game event","event"),Engine.keyLock=!0,Engine.tabNavigation=!1,Button.saveCooldown=!1,Events.eventStack.unshift(t),t.eventPanel=$("<div>").attr("id","event").addClass("eventPanel").css("opacity","0"),null!=e&&null!=e.width&&Events.eventPanel().css("width",e.width),$("<div>").addClass("eventTitle").text(Events.activeEvent().title).appendTo(Events.eventPanel()),$("<div>").attr("id","description").appendTo(Events.eventPanel()),$("<div>").attr("id","buttons").appendTo(Events.eventPanel()),Events.loadScene("start"),$("div#wrapper").append(Events.eventPanel()),Events.eventPanel().animate({opacity:1},Events._PANEL_FADE,"linear"),Events.activeEvent().scenes[Events.activeScene].blink&&Events.blinkTitle())},scheduleNextEvent:function(t){var e=Math.floor(Math.random()*(Events._EVENT_TIME_RANGE[1]-Events._EVENT_TIME_RANGE[0]))+Events._EVENT_TIME_RANGE[0];t>0&&(e*=t),Engine.log("next event scheduled in "+e+" minutes"),Events._eventTimeout=Engine.setTimeout(Events.triggerEvent,60*e*1e3)},endEvent:function(){AudioEngine.stopEventMusic(),Events.eventPanel().animate({opacity:0},Events._PANEL_FADE,"linear",(function(){Events.eventPanel().remove(),Events.activeEvent().eventPanel=null,Events.eventStack.shift(),Engine.log(Events.eventStack.length+" events remaining"),Engine.keyLock=!1,Engine.tabNavigation=!0,Button.saveCooldown=!0,Events.BLINK_INTERVAL&&Events.stopTitleBlink(),$("body").focus()}))},handleStateUpdates:function(t){"stores"!=t.category&&"income"!=t.category||null==Events.activeEvent()||Events.updateButtons()},initDelay:function(){$SM.get(Events.delayState)&&Events.recallDelay(Events.delayState,Events)},recallDelay:function(t,e){var n=$SM.get(t);for(var a in n)"object"==typeof n[a]?Events.recallDelay(t+'["'+a+'"]',e[a]):"function"==typeof e[a]?e[a]():$SM.remove(t);$.isEmptyObject(n)&&$SM.remove(t)},saveDelay:function(t,e,n){var a=Events.delayState+"."+e;n?$SM.set(a,n):n=$SM.get(a,!0);var o=Engine.setInterval((function(){$SM.set(a,$SM.get(a)-.5,!0)}),500);Engine.setTimeout((function(){window.clearInterval(o),$SM.remove(a),$SM.removeBranch(Events.delayState),t()}),1e3*n)}};